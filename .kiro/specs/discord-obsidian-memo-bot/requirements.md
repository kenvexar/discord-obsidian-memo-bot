# Requirements Document

## Introduction

Discordボットを作成し、ユーザーがDiscord上で手軽にメモを入力・管理できるようにします。入力されたメモはObsidianに連携され、無料のAI APIによる高度な情報処理（要約、キーワード抽出など）を自動化することで、強力なパーソナルナレッジベース構築を支援します。このボットは個人利用を前提とし、ツェッテルカステンとライフログの概念を取り入れた体系的なナレッジ管理システムを構築します。

システムは以下の構成で動作します：
- **Obsidian Vault構造**: 00_Capture/, 01_Process/, 02_Knowledge/, 03_Projects/, 04_Life/(Daily/, Finance/, Health/, Tasks/, Schedule/), 05_Resources/, 99_Meta/
- **Discord チャンネル構成**: 📝 CAPTURE, 💰 FINANCE, 📋 PRODUCTIVITY, ⚙️ SYSTEM カテゴリ
- **連携フロー**: Discord → ボット → 無料AI API → Obsidian の自動処理
- **主要技術**: Discord.py, Google Gemini API Free Tier (google-generativeai), python-garminconnect, Google Cloud Speech-to-Text API Free Tier
- **デプロイメント**: Google Cloud Run (無料枠)

## Requirements

### Requirement 1

**ユーザーストーリー:** ユーザーとして、📝 CAPTUREカテゴリのDiscordチャンネル（#inbox、#voice、#files）にメッセージを投稿し、それらを自動的にメモとして取得したい。手動でのデータ転送なしに素早く思考を入力できるようにするため。

#### Acceptance Criteria

1. 📝 CAPTUREカテゴリの#inboxチャンネルに新しいメッセージが投稿された時、ボットはリアルタイムでメッセージ内容を検知し取得する
2. 📝 CAPTUREカテゴリの#filesチャンネルにファイル付きメッセージが投稿された時、ボットはリアルタイムでメッセージ内容を検知し取得する
4. ボットがメッセージを取得した時、タイムスタンプ、チャンネルソース情報、ユーザー情報を含める
3. メッセージに添付ファイル（画像、PDF、テキストファイル）が含まれている時、ボットはファイルを検知し05_Resources/フォルダに安全に保存し、Obsidianノート内にファイルへのリンクを自動生成する
4. ユーザーが⚙️ SYSTEMカテゴリの#commandsチャンネルで/memoコマンドを使用した時、ボットは特定のメッセージのみをメモとして処理するオプションを提供する

### Requirement 2

**ユーザーストーリー:** ユーザーとして、📝 CAPTUREカテゴリの#voiceチャンネルで音声メモを録音し、テキストに変換してもらいたい。タイピングが不便な時に思考を取得できるようにするため。

#### Acceptance Criteria

1. 📝 CAPTUREカテゴリの#voiceチャンネルに音声ファイルが投稿された時、ボットは音声ファイルを検知する
2. 音声ファイルが検知された時、ボットはGoogle Cloud Speech-to-Text APIの無料枠（月60分）を使用して音声をテキストに変換する
3. 月の無料枠を超過した場合、ボットは音声ファイルを05_Resources/に保存し、手動変換用のリンクをObsidianノートに含める
4. 音声テキスト変換が完了した時、ボットは変換されたテキストを通常のテキストメモと同様に、投稿されたチャンネルに応じて適切にObsidianに連携する
5. 音声変換が失敗した時、ボットはユーザーに明確なエラーメッセージを通知し、元の音声ファイルを保持する
6. 音声認識API使用量が月制限の80%に達した時、ボットは⚙️ SYSTEMカテゴリの#notificationsチャンネルに警告を送信する

### Requirement 3

**User Story:** ユーザーとして、メモを自動的にAIで要約・分類処理してもらい、既存の知識との関連性も発見したい。手動作業なしにノートが整理され検索可能になり、知識のネットワークが自動構築されるようにするため。

#### Acceptance Criteria

1. メモが取得された時、Google Gemini API Free Tier（月15リクエスト/分、1日1500リクエスト）を使用して簡潔な要約を生成する
2. 内容が処理された時、Gemini APIは関連キーワードを抽出しタグに変換する
3. メモが分析された時、Gemini APIは事前定義されたオプションから適切なカテゴリを提案する
4. 新しいメモが処理された時、Gemini APIはObsidian Vault内の既存ノートとの関連性を分析し、関連する既存ノートへの[[内部リンク]]を提案する
5. URLが含まれるメモが処理された時、Gemini APIはWebページの内容を要約し、メモに追加情報として含める
6. API制限に達した場合、ボットは処理を一時停止し、制限リセット後に自動再開する
7. 処理が完了した時、AI生成されたすべてのメタデータ（要約、タグ、カテゴリ、関連リンク）がObsidianノートに含まれる
8. Gemini API処理が失敗した場合、ボットは元のメモを保存しエラーをログに記録する

### Requirement 4

**User Story:** ユーザーとして、処理されたメモを体系的なObsidianフォルダ構造に自動保存してもらいたい。ツェッテルカステンとライフログの概念に基づいたナレッジ管理システムでアクセスできるようにするため。

#### Acceptance Criteria

1. メモが処理された時、ボットはObsidian vaultに新しいMarkdownファイルを作成する
2. ファイルを作成する時、ファイル名はYYYYMMDDHHMM_タイトル.md形式に従う
3. 📝 CAPTUREカテゴリからのメモが処理された時、00_Capture/フォルダに保存する
4. 活動ログ関連のメッセージが処理された時、04_Life/Daily/のその日のデイリーノート（YYYY-MM-DD.md）の## Activity Logセクションに追記する
5. 📋 PRODUCTIVITYカテゴリからのタスク関連メッセージが処理された時、04_Life/Daily/のその日のデイリーノートの## Tasksセクションに追記する
6. ノートを作成する時、YAMLフロントマターに日付、時刻、ソース（Discord）、タグ、要約、カテゴリを含める
7. Gemini APIによる分類結果に基づいて、将来的に02_Knowledge/、03_Projects/への移動を提案する機能を準備する
8. ノートが作成された時、ボットは作成されたノートへのリンクとともにフィードバックを提供する

### Requirement 5

**User Story:** ユーザーとして、ボットからフィードバックを受け取り、必要に応じてコマンドでシステムを制御し、知識の検索や統計情報も取得したい。システムの状態を理解し、蓄積された知識を活用できるようにするため。

#### Acceptance Criteria

1. ユーザーが/helpと入力した時、ボットは利用可能なコマンドと使用方法を日本語で表示する
2. ユーザーが/statusと入力した時、ボットは現在のシステム状態、最近の活動、処理済みメモ数を表示する
3. ユーザーが/search [キーワード]と入力した時、ボットはObsidian Vault内の関連ノートを検索し結果を表示する
4. ユーザーが/statsと入力した時、ボットは今日・今週・今月の統計情報（メモ数、チャンネル別集計、よく使われるタグ）を表示する
5. ユーザーが/random_noteと入力した時、ボットは過去のノートからランダムに1つを選んで再表示し、知識の再発見を促す
6. メモ処理が完了した時、ボットはObsidianノートリンクとともに成功メッセージを送信する
7. エラーが発生した時、ボットは明確なエラー情報でユーザーに通知する
8. 設定コマンドを使用した時、ボットは設定を更新し変更を確認する

### Requirement 6

**User Story:** ユーザーとして、ボット設定を構成し、⚙️ BOT_SETTINGSカテゴリでシステムの健全性を監視したい。信頼性の高い運用を維持するため。

#### Acceptance Criteria

1. チャンネル設定が変更された時、ボットは監視対象を即座に更新する
2. APIキー（Discord、Gemini CLI）が更新された時、ボットは新しい認証情報を検証し適用する
3. システムエラーが発生した時、ボットは詳細をログに記録し#bot-notificationsチャンネルに通知する
4. ボットがAPI障害に遭遇した時、指数バックオフでリトライロジックを実装する
5. 管理者が設定コマンドを使用した時、連携チャンネルの追加・削除、Obsidianフォルダパスの変更が可能である

### Requirement 7

**User Story:** ユーザーとして、99_Meta/フォルダのテンプレートを活用して一貫性のあるノート作成を行いたい。Gemini APIが抽出した情報を効率的にノートに埋め込むため。

#### Acceptance Criteria

1. ボットがノートを作成する時、99_Meta/フォルダから適切なテンプレートを選択する
2. テンプレートが選択された時、Gemini CLIが抽出した要約、タグ、カテゴリ情報をプレースホルダーに自動で埋め込む
3. デイリーノートが作成される時、99_Meta/のデイリーノートテンプレートを使用し、## Activity Log、## Tasks、## Scheduleセクションを含める
4. 新しいアイデアノートが作成される時、99_Meta/のアイデアノートテンプレートを使用する

### 要件8

**ユーザーストーリー:** ユーザーとして、python-garminconnectを使用してGarminデバイスからの健康データ（睡眠、活動、心拍数など）を自動的に取得し、Obsidianのデイリーノートに統合したい。包括的なライフログとパーソナルナレッジベースを構築するため。

#### 受け入れ基準

1. ボットがpython-garminconnectライブラリを使用してGarmin Connectアカウントに接続する時、安全な認証を実装する
2. 毎日定期的にGarminデータが取得される時、睡眠データ、歩数、心拍数、活動データを含める
3. Garminデータが取得された時、02_DailyNotes/のその日のデイリーノート（YYYY-MM-DD.md）の## Health Dataセクションに自動追記する
4. Garminデータが処理される時、Gemini API無料枠の範囲内でデータの要約と健康に関する洞察を生成する（週1回程度に制限）
5. API制限を考慮し、健康データ分析は重要な変化がある場合のみ実行する
6. Garmin API接続エラーが発生した時、ボットは#bot-notificationsチャンネルにエラー詳細を通知する
7. Garminデータが正常に更新された時、ボットは#bot-notificationsチャンネルに成功通知を送信する
8. 既存のDiscordからの活動ログとGarminデータが統合される時、デイリーノート内で時系列順に整理される

### Requirement 9

**User Story:** ユーザーとして、定期的な自動レビューと知識の整理提案を受けたい。蓄積された情報を効果的に活用し、知識の質を向上させるため。

#### Acceptance Criteria

1. 毎週日曜日の夜に、ボットは00_Inbox/フォルダ内の未整理メモの数を#bot-notificationsチャンネルに通知する（AI処理なし）
2. 月末に、ボットはその月の活動サマリー（メモ数、主要なトピック、よく使われたタグ）をGemini API無料枠で生成し報告する（月1回のみ）
3. 00_Inbox/に30日以上滞在しているメモがある時、ボットは整理を促すリマインダーを送信する（AI処理なし）
4. 関連性の高いメモが複数蓄積された時、ボットは01_PermanentNotes/への統合を提案する（ルールベース分析）
5. 同じトピックのメモが一定数蓄積された時、ボットは03_Projects/または04_Areas/への分類を提案する（ルールベース分析）

### Requirement 10

**User Story:** ユーザーとして、API無料枠を効率的に管理し、コストを抑えながらシステムを運用したい。予算を超えることなく継続的にサービスを利用するため。

#### Acceptance Criteria

1. WHEN ボットがGemini API使用量を追跡する時 THEN システムは日次・月次制限の80%に達した時に#bot-notificationsチャンネルに警告を送信する
2. WHEN ボットがGoogle Cloud Speech-to-Text API使用量を追跡する時 THEN システムは月60分の80%に達した時に警告を送信する
3. WHEN API制限に達した時 THEN ボットは新しいメモを基本的なメタデータ（日時、チャンネル、ユーザー）のみでObsidianに保存する
4. WHEN 制限リセット後 THEN ボットは未処理のメモを自動的にキューから処理する
5. WHEN 音声認識制限に達した場合 THEN 音声ファイルは05_Resources/に保存し、手動変換を促すメッセージを含める
6. WHEN 重要度の低い処理（月次サマリー、健康データ分析）を実行する時 THEN システムは制限に余裕がある時のみ実行する

### Requirement 11

**User Story:** ユーザーとして、Google Cloud Runの無料枠を活用してシステムが24時間365日安定して動作してもらいたい。重要なメモを失ったり、サービス停止時にデータが失われないようにするため。

#### Acceptance Criteria

1. ボットがGoogle Cloud Run上で実行されている時、安定したパフォーマンスを維持する
2. 無料枠の制限（月180,000 vCPU秒、200万リクエスト）内で24時間365日稼働する
3. コールドスタート時の遅延（数秒）を考慮した設計を実装する
4. メモが投稿された時、コールドスタート含めて10秒以内に処理を完了する
5. APIエラーが発生した時、ボットは適切なエラーハンドリングと復旧を実装する
6. 認証情報や機密データが処理される時、Google Cloud Secret Managerまたは環境変数を使用して安全に保存される
7. 重要なシステムイベント（起動、エラー復旧、制限警告）が発生した時、ボットは#bot-notificationsチャンネルにログを送信する
8. Obsidianファイルは定期的にGoogle Cloud StorageまたはGitHubにバックアップされる
9. 月次使用量が無料枠の80%に達した時、#bot-notificationsチャンネルに警告を送信する

### 要件12

**ユーザーストーリー:** ユーザーとして、Obsidianで定期購入サービス（Netflix、Spotify、SaaS、雑誌購読など）と一般的な収支を管理し、Discordボットを通じて支払い予定の通知や家計トラッキングを受けたい。定期購入の見落としを防ぎ、包括的な家計管理と支出の最適化を効率的に行うため。

#### 受け入れ基準

1. ボットが04_Life/Finance/フォルダを作成し、定期購入サービス管理専用の領域を提供する
2. ユーザーが/sub_add [サービス名] [金額] [支払い周期] [次回支払い日]コマンドを使用した時、ボットは新しい定期購入をObsidianに登録する（例：/sub_add "Netflix" 1490 monthly "2024-01-15"）
3. 定期購入が登録された時、04_Life/Finance/[サービス名].mdファイルが以下の構造で生成される：
   - YAMLフロントマター（登録日、金額、支払い周期、次回支払い日、ステータス、カテゴリ）
   - サービス詳細セクション
   - 支払い履歴セクション
   - 年間コスト計算セクション
4. ボットが毎日朝8時に支払い予定をチェックし、3日以内に支払いがあるサービスを💰 FINANCEカテゴリの#moneyチャンネルに通知する
5. ユーザーが/sub_paid [サービス名]コマンドで支払い完了を報告した時、ボットはObsidianファイルの支払い履歴に記録し、次回支払い日を自動計算して更新する
6. ユーザーが/sub_listコマンドを使用した時、ボットは全ての定期購入サービスと次回支払い日、月額・年額費用を表示する
7. ユーザーが/sub_stats [期間]コマンドを使用した時、ボットは指定期間（月/年）の総支出、カテゴリ別支出、最も高額なサービスを表示する
8. 支払い予定日を3日過ぎても支払い報告がない時、ボットは💰 FINANCEカテゴリの#moneyチャンネルにリマインダーを送信する
9. ユーザーが/sub_pause [サービス名]、/sub_resume [サービス名]、/sub_cancel [サービス名]コマンドで定期購入の状態を管理できる
10. 月末に、ボットは全定期購入の月次レポート（総支出、前月比較、未使用サービスの検出、コスト最適化提案）をGemini API無料枠で生成し💰 FINANCEカテゴリの#reportsチャンネルに送信する（月1回のみ）
11. 定期購入の支払い記録が02_DailyNotes/のデイリーノートの## Expensesセクションにも自動的に記録される
12. 99_Meta/に定期購入サービス用テンプレートが作成され、一貫したフォーマットでサービスファイルが生成される
13. ユーザーが💰 FINANCEカテゴリの#moneyチャンネルに支出情報を投稿した時（例：「支出 コンビニ 500円 食費」）、ボットは支出を自動的に記録する
14. ユーザーが💰 FINANCEカテゴリの#moneyチャンネルに収入情報を投稿した時（例：「収入 給与 300000円」）、ボットは収入を自動的に記録する
15. 支出・収入が記録された時、ボットは04_Life/Daily/のデイリーノートの## Expensesまたは## Incomeセクションに自動追記する
16. ユーザーが/budget_set [カテゴリ] [月額予算]コマンドを使用した時、ボットは月次予算を設定し、支出が予算の80%に達した時に警告を送信する
17. ユーザーが/finance_stats [期間]コマンドを使用した時、ボットは収支バランス、カテゴリ別支出、予算達成率を表示する
18. 月末に、ボットは全体的な家計レポート（収支バランス、予算達成率、節約提案）をGemini API無料枠で生成し💰 FINANCEカテゴリの#reportsチャンネルに送信する（月1回のみ）

### 要件13


**ユーザーストーリー:** ユーザーとして、Obsidianでタスク管理とスケジュール管理を行い、Discordボットを通じてリマインダーや進捗トラッキングを受けたい。重要なタスクの見落としを防ぎ、効率的な時間管理と生産性向上を実現するため。

#### 受け入れ基準

1. ボットが04_Life/Tasks/フォルダを作成し、タスク・スケジュール管理専用の領域を提供する
2. ユーザーが/task_add [タスク名] [期限] [優先度] [説明]コマンドを使用した時、ボットは新しいタスクをObsidianに作成する（例：/task_add "プレゼン資料作成" "2024-01-20" high "来週の会議用"）
3. タスクが作成された時、04_Life/Tasks/[YYYYMMDD]_[タスク名].mdファイルが以下の構造で生成される：
   - YAMLフロントマター（作成日、期限、優先度、ステータス、カテゴリ、進捗率）
   - タスク詳細セクション
   - 進捗記録セクション
   - 関連リンクセクション
4. ボットが毎日朝8時にタスクをチェックし、期限が近い（3日以内）または期限を過ぎたタスクを📋 PRODUCTIVITYカテゴリの#tasksチャンネルに通知する
5. ユーザーが/task_update [タスク名] [進捗率]コマンドでタスクの進捗を更新した時、ボットはObsidianファイルの進捗記録に記録する
6. ユーザーが/task_done [タスク名]コマンドでタスク完了を報告した時、ボットはタスクのステータスを完了に更新し、完了日を記録する
7. ユーザーが/task_listコマンドを使用した時、ボットは全てのアクティブなタスクを優先度・期限順で表示する
8. ユーザーが/schedule_add [イベント名] [日時] [場所] [説明]コマンドを使用した時、ボットは新しいスケジュールをObsidianに作成する
9. スケジュールが作成された時、04_Life/Schedule/[YYYYMMDD]_[イベント名].mdファイルが生成される
10. ボットが毎日朝8時にスケジュールをチェックし、当日・翌日のイベントを📋 PRODUCTIVITYカテゴリの#tasksチャンネルに通知する
11. タスクとスケジュールの情報が02_DailyNotes/のデイリーノートの## Tasks、## Scheduleセクションにも自動的に記録される
12. ユーザーが/task_stats [期間]コマンドを使用した時、ボットは指定期間のタスク完了率、平均完了時間、優先度別統計を表示する
13. 月末に、ボットはタスク・スケジュール管理の月次レポート（完了率、生産性分析、改善提案）をGemini API無料枠で生成し📋 PRODUCTIVITYカテゴリの#reviewsチャンネルに送信する（月1回のみ）
14. 99_Meta/にタスク・スケジュール用テンプレートが作成され、一貫したフォーマットでファイルが生成される
